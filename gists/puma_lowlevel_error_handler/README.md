# `lowlevel_error_handler`

```
$ curl -s -v http://127.0.0.1:3000
* Rebuilt URL to: http://127.0.0.1:3000/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 3000 (#0)
> GET / HTTP/1.1
> Host: 127.0.0.1:3000
> User-Agent: curl/7.54.0
> Accept: */*
>
< HTTP/1.1 500 Internal Server Error
< Content-Type: application/json
< Content-Length: 37
<
* Connection #0 to host 127.0.0.1 left intact
{"status":500,"error":"Server error"}
```

```
$ bundle exec puma -C config/puma.rb
[45167] Puma starting in cluster mode...
[45167] * Version 3.6.2 (ruby 2.4.2-p198), codename: Sleepy Sunday Serenity
[45167] * Min threads: 16, max threads: 16
[45167] * Environment: development
[45167] * Process workers: 2
[45167] * Preloading application
I, [2017-11-29T13:03:23.840893 #45167]  INFO -- sentry: ** [Raven] Raven 2.6.3 configured not to capture errors: DSN not set
[45167] * Listening on tcp://0.0.0.0:3000
[45167] Use Ctrl-C to stop
[45167] - Worker 0 (pid: 45179) booted, phase: 0
[45167] - Worker 1 (pid: 45180) booted, phase: 0
2017-11-29 13:03:34 +0100: Rack app error handling request { GET / }
#<RuntimeError: low level error>
config.ru:14:in `call'
/Users/dentarg/.gem/ruby/2.4.2/gems/newrelic_rpm-3.17.2.327/lib/new_relic/agent/instrumentation/middleware_tracing.rb:96:in `call'
/Users/dentarg/.gem/ruby/2.4.2/gems/puma-3.6.2/lib/puma/configuration.rb:225:in `call'
/Users/dentarg/.gem/ruby/2.4.2/gems/puma-3.6.2/lib/puma/server.rb:578:in `handle_request'
/Users/dentarg/.gem/ruby/2.4.2/gems/puma-3.6.2/lib/puma/server.rb:415:in `process_client'
/Users/dentarg/.gem/ruby/2.4.2/gems/puma-3.6.2/lib/puma/server.rb:275:in `block in run'
/Users/dentarg/.gem/ruby/2.4.2/gems/puma-3.6.2/lib/puma/thread_pool.rb:116:in `block in spawn_thread'
```

The above output is generated by this call in [server.rb] to this method in [events.rb].

[server.rb]: https://github.com/puma/puma/blob/ac7106e96d70c87c70cf58ce4312acb045845a01/lib/puma/server.rb#L645-L649
[events.rb]: https://github.com/puma/puma/blob/60f54434b4d203fbbe43ad6c553991abe08230f9/lib/puma/events.rb#L106-L123

`config.ru`

```ruby
# from https://github.com/jjb/reproduce-puma-1287

class LowLevelTester
  def initialize(app)
    @app = app
  end

  def call(env)
    raise "low level error"

    @app.call(env)
  end
end

use LowLevelTester
```

`config/puma.rb`

```ruby
# frozen_string_literal: true

workers 2
threads 4, 16

preload_app!

port        ENV["PORT"]     || 3000
environment ENV["RACK_ENV"] || "development"

lowlevel_error_handler do |error, env|
  # Send to Sentry (when RACK_ENV=production)
  Raven.capture_exception(
    error,
    message: error.message,
    extra: { puma: env },
    culprit: "Puma"
  )

  # Rack response
  status = 500
  [
    status,
    { "Content-Type" => "application/json" },
    [JSON.dump(status: status, error: "Server error")],
  ]
end

on_worker_boot do
  # ...
end
```
